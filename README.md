# Random Walker Segmentation Tool

Интерактивное приложение для сегментации  изображений методом **Random Walker**. Проект ориентирован на применение в задачах **неразрушающего контроля**, где объекты имеют сложную пористую или ветвящуюся структуру и необходимо эффективно распространять семантические метки от меток-маркеров.

---

## Особенности

-  Алгоритм Random Walker на графе
-  Поддержка пользовательской разметки (маркеров)
-  Гибкие функции веса (яркость, градиент, дисперсия)
-  Подходит для высококонтрастных изображений

---

## Теоретическая основа

**Random Walker** (Grady, 2006) — метод сегментации, основанный на вероятностной диффузии. Изображение представляется в виде графа, где:

- каждая вершина — пиксель
- рёбра соединяют соседние пиксели
- веса рёбер определяют схожесть (чем ближе значения, тем выше вес)

Алгоритм решает уравнение Лапласа на этом графе:

> "Какова вероятность, что блуждающий по графу маркер, начавший путь в пикселе i, впервые достигнет метки класса k в пикселе j?"

Эта вероятность и определяет принадлежность пикселя к классу (фон/объект).

### Основные шаги алгоритма:

1. **Пользователь размечает маркеры** (фон и объект)
2. **Построение графа:** пиксели → вершины, соседи → рёбра
3. **Назначение весов:**
    - Стандартный вес: `exp(-beta * (I_i - I_j)^2)`
4. **Составление и решение системы уравнений:**
    - Решается линейная система: `L_u x_u = -B.T x_m`
    - Где `L_u` — подматрица Лапласиана для немеченных пикселей
5. **Назначение меток:** по наибольшей вероятности
6. **Результат отображается поверх исходного изображения**

---

## Ограничения Random Walker
-  **Не работает без маркеров**: не сегментирует автоматически
- **Неустойчив к слабому контрасту**: вес между пикселями не падает, граница становится проходимой
- **Не учитывает форму/геометрию** объекта напрямую
-  **Плохо работает при сильной неоднородности объекта** (если он сам по себе шумный)    

**Важно:** алгоритм не "ищет объекты" — он распространяет заданные метки по графу.

---

## Как использовать программу

### Загрузка изображения
1. Запустите программу
2. Нажмите **"Load Image"** и выберите изображение. Даже цветные изображения будут автоматически переведены в градации серого, поскольку алгоритм ориентирован на работу с рентгеновскими и томографическими данными./

###  Разметка маркеров

1. Выберите метку: `Background` (синий) или `Object` (красный)
2. Нарисуйте **один или несколько прямоугольников** по соответствующим областям
    - Например: один внутри объекта, другой — вне его, на фоне

###  Запуск сегментации

- Нажмите **"Run Algorithm"**
- Через некоторое время появится результат поверх изображения

###  Очистка
- Кнопка **"Clear"** удаляет разметку и результат

---

##  Формат входных изображений

- Только **одноканальные** изображения
- Поддержка: `.png`, `.jpg`, `.bmp`
- Рекомендуется: разрешение до 1024x1024
- Контрастные изображения дают лучший результат

---
##  Настройка параметра чувствительности β (beta)

Алгоритм `Random Walker` использует весовую функцию для построения графа:

```
w_ij = exp(-β * (I_i - I_j)^2)
```

где:
- `I_i`, `I_j` — интенсивности соседних пикселей;
- `β` — параметр чувствительности к градиентам, управляющий "жесткостью" границ.

---

### Где задается параметр

Фиксированное значение `β` задается в:

```
core/graph/PixelGraph.cpp
```

```cpp
static constexpr double kBeta = 0.05;
```

Для изменения — отредактируйте это значение и пересоберите проект.

---

### ⚖️ Рекомендации по выбору значения β

| Тип изображения           | Контраст | Шум     | Рекомендуемый β |
| ------------------------- | -------- | ------- | --------------- |
| Бинарное (ч/б)            | Высокий  | Низкий  | `0.001 – 0.01`  |
| Полутоновое, однородное   | Средний  | Низкий  | `0.02 – 0.05`   |
| Слабоконтрастное, с шумом | Низкий   | Высокий | `0.05 – 0.1`    |

- **Меньший β** → метки распространяются свободно (мягкие границы);
- **Больший β** → сегментация более строго следует границам (риск изоляции при шуме).

---

###  Предупреждение

- **Слишком малый β**:
  - снижает чувствительность к границам;
  - вызывает утечки меток через фон;
- **Слишком большой β**:
  - разрушает связность;
  - метки не распространяются и "залипают".

---

## Потенциальные улучшения

###  Адаптивный β

- Вычисление β на основе дисперсии интенсивностей:
```
beta = 1 / (2 * sigma^2)
```

или локально:
```
beta_ij = 1 / (2 * (sigma_i^2 + sigma_j^2))
```

###  Пространственно-взвешенный β

- Использование градиентов и текстур:
```
compute_weight_gradient(...)
```

###  Автоматическая инициализация

- Выбор β на основе анализа входного изображения:
  - гистограмма;
  - контраст;
  - уровень шума (SNR).

---
##  Внутренняя структура

| Модуль                              | Назначение                            |
| ----------------------------------- | ------------------------------------- |
| `RandomWalkerAlgorithm.hpp/cpp`     | Построение графа, веса, решение СЛАУ  |
| `PixelGraph.hpp/cpp`                | Представление изображения как графа   |
| `SceneManager.hpp/cpp`              | Связь между QML и C++ логикой         |
| `global.hpp`, `MetaAnnotations.hpp` | Концепты, типы, аннотации             |
| `ImageToEigen.hpp`                  | Преобразование QImage → Eigen матрицы |

---

# Расширение алгоритма Random Walker: модификации и будущие направления

Алгоритм Random Walker обеспечивает высокое качество сегментации при наличии четких маркеров и контрастных границ, однако в условиях шума, неоднородности и отсутствия полной разметки его эффективность снижается. Ниже представлены  направления его модификации и автоматизации.

---

## 1. Автоматическое размещение маркеров

Вместо ручной разметки можно использовать автоматические стратегии генерации маркеров

###  Подход 1: Connected Components + морфология

- Бинаризация (например, методом Otsu):  $B(x, y) = I(x, y) > T$
- Выделение связных компонент:  $\text{label}(B) \rightarrow \{C_i\}$
- Автоматическое размещение маркера в центре масс $C_i$:
$$ m_i = \frac{1}{|C_i|} \sum_{(x, y) \in C_i} (x, y) $$
###  Подход 2: Кластеризация интенсивности
- K-means или Gaussian Mixture Model на значениях интенсивности
- Маркеры размещаются в наиболее плотных кластерах, порогованно

---

##  2. Устойчивость к шуму и слабому контрасту

### Модификация весовой функции
- Классический вес: $w_{ij} = \exp(-\beta (I_i - I_j)^2)$
- Модифицированный вес с адаптивной $\beta$:
    $$\beta = \frac{1}{2 \cdot \mathrm{Var}(I) + \varepsilon} \quad \Rightarrow \quad w_{ij} = \exp\left(- \frac{(I_i - I_j)^2}{2 \operatorname{Var}(I) + \varepsilon}\right)$$

###  Альтернатива: использование градиентного поля

- Вместо интенсивности используем норму градиента:
    $$\nabla I = \left( \frac{\partial I}{\partial x}, \frac{\partial I}{\partial y} \right) \quad \Rightarrow \quad w_{ij} = \exp(-\gamma \cdot \| \nabla I_{ij} \|^2)$$

###  Сглаживание изображения до построения графа

- Применение фильтров (Gaussian, Bilateral) перед построением весов:
    $$I' = G_\sigma * I \quad \text{или} \quad I' = \text{bilateral}(I, \sigma_s, \sigma_r)$$
- Снижение влияния высокочастотного шума на веса
    


---

##  3. Расширение топологии графа
###  Использование не только 4-/8-соседства, но и геодезической близости
- Расширенные связи: $w_{ij} \neq 0$ даже при $\|i - j\| > 1$
- Геодезическое расстояние по изображению:
    $$d_G(i, j) = \min_{\pi \in \text{paths}(i \to j)} \sum_{(u,v) \in \pi} \frac{1}{w_{uv}}$$
- Помогает при разрывах в объекте
    

---

##  4. Поддержка мультиклассовой сегментации

Random Walker естественным образом поддерживает многоклассовую сегментацию:

- Каждому классу назначается своя метка
- Решается система для каждого класса отдельно:
$$ L_u x_u^{(k)} = -B^T x_m^{(k)} \quad \forall k = 1 \dots K$$
- Итоговая метка — по максимальной вероятности:
$$ \text{label}(i) = \arg\max_k x_u^{(k)}(i)$$

---
## 5. Интеграции

Возможны модификации интеграцией с другими методами: graph-cut, snake-algorithm, градиентные методы.

---

# Применение Random Walker в промышленной дефектоскопии

Алгоритм Random Walker может применяться в задачах **неразрушающего контроля** (NDT) и **промышленной томографии**, где необходимо выявление дефектов в материалах по рентгеновским, КТ- и МРТ-изображениям. Он особенно эффективен в случаях, когда объекты имеют **разветвлённую или пористую структуру**, а границы между фоном и дефектом выражены в яркостном или текстурном контрасте.

---

## Типовые применения в дефектоскопии

- Поиск **трещин, пустот, пор и инородных включений** в композитах, металлах, керамике
- Анализ **сварных швов** и внутренних напряжений
- Сегментация **деталей в сборе** (механических или электронных)
- Автоматическая разметка в потоке **высокоскоростного контроля** (inline inspection)


---

## Автоматизация поиска дефектов

Даже несмотря на необходимость разметки, RW можно адаптировать под **автоматическое обнаружение**:
###  Генерация маркеров через локальную аномалию
- Вычисление локальной дисперсии $\sigma^2_{\text{local}}(x, y)$ или энтропии окна
- Детектирование пиков и впадин, как потенциальных маркеров дефекта
- Фоновые маркеры: в однородных областях с низкой вариативностью

### Использование морфологических фильтров
- Применение `top-hat`, `black-hat`, `closing-open` для выделения структурной разницы
- Порогование и выбор стабильных компонент как маркеров

### Кластеризация признаков
- Использование PCA, t-SNE или autoencoder-признаков + DBSCAN/KMeans для предварительной сегментации
- Преобразование кластеров в карту вероятностей для инициализации RW

---
##  Ограничения в условиях промышленного шума

- **Низкий контраст** между фоном и дефектом → веса становятся слабо дискриминативны
- **Металлографический шум** и артефакты мешают определению стабильных маркеров
- **Тонкие и вытянутые структуры** (например, микротрещины) требуют высокой плотности графа или уточнённой топологии

> Возможное решение: комбинированный подход RW + фильтрация + постобработка на графе (удаление малых компонент, skeletonization)


При этом его математическая строгость (решение уравнения Лапласа) делает результат стабильным и воспроизводимым, что критично для задач инженерного контроля.
##  Полезные ссылки

- [Original Random Walker paper (Grady, 2006)](https://ieeexplore.ieee.org/document/1704833)
- [Fast Approximate RW (Grady & Sinop, 2008)](https://ieeexplore.ieee.org/document/4541126)
- [Modified RW segmentation (Bai & Wang, 2009)](https://ieeexplore.ieee.org/document/4761502)
- Eigen documentation
- Qt documentation

---

## Лицензия

BSD 3-Clause License

